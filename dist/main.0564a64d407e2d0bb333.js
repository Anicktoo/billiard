(()=>{"use strict";class t{_x;_y;constructor(t,e){this._x=t,this._y=e}getLength(){return Math.sqrt(this._x*this._x+this._y*this._y)}isNormal(){return 1===this.getLength()}getNormalized(){const e=this.getLength();if(!e)return new t(0,0);const i=this._x/e,s=this._y/e;return new t(i,s)}add(e,i=1){return new t(this._x+e.x*i,this._y+e.y*i)}substract(e){return new t(this._x-e.x,this._y-e.y)}scale(e){return new t(this._x*e,this._y*e)}dot(t){return this._x*t.x+this._y*t.y}isZero(){return 0===this._x&&0===this._y}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}}class e{static CUE_COLOR="#2f1212";static WALL_COLOR="#221205";static TABLE_COLOR="#225522";static POCKET_COLOR="#000000";static BALLS_COLORS={main:"#551122",ordinary:"#FFFFFF"};static sprites={table:void 0};_ctxBalls;_ctxCue;_cueWidth;_maxSpace;_ctxTable;_fadeStop;_cueLength;_tableWidth;_tableHeight;_initialSpace;_cueSpaceWidth;_cueSpaceHeight;_viewToModelProportion;constructor(t,e,i){this._ctxTable=t.getContext("2d"),this._ctxCue=i.getContext("2d"),this._ctxBalls=e.getContext("2d")}async init(e,i,s){this._cueSpaceWidth=i.width,this._cueSpaceHeight=i.height,this._tableWidth=e.width,this._tableHeight=e.height,this._viewToModelProportion=this._tableWidth/s,this.tablePos=new t(e.getBoundingClientRect().left,e.getBoundingClientRect().top),this._cueLength=this._tableHeight,this._cueWidth=this._cueLength/64,this._initialSpace=this._cueWidth,this._maxSpace=30*this._initialSpace,await this.loadSprites()}loadSprites(){return new Promise((t=>{const i=Object.keys(e.sprites);let s=0;const h=o=>{e.sprites[o]=new Image,e.sprites[o].onload=()=>{s==i.length-1?(console.log("resolve"),t()):h(i[++s])},e.sprites[o].src=`img/${o}.png`};h(i[s])}))}renderTable(){this._ctxTable.clearRect(0,0,this._tableWidth,this._tableHeight),this._ctxTable.fillStyle=e.TABLE_COLOR,this._ctxTable.fillRect(0,0,this._tableWidth,this._tableHeight),this._ctxTable.drawImage(e.sprites,0,0)}renderPockets(t,i){this._ctxTable.fillStyle=e.POCKET_COLOR;for(let{x:e,y:s}of t)this._ctxTable.beginPath(),this._ctxTable.arc(e*this._viewToModelProportion,s*this._viewToModelProportion,i*this._viewToModelProportion,0,2*Math.PI,!1),this._ctxTable.fill()}renderWalls(t){this._ctxTable.fillStyle=e.WALL_COLOR;for(let e of t)this._ctxTable.fillRect(e.x*this._viewToModelProportion,e.y*this._viewToModelProportion,e.width*this._viewToModelProportion,e.height*this._viewToModelProportion)}renderBalls(t,i){this._ctxBalls.clearRect(0,0,this._tableWidth,this._tableHeight),i*=this._viewToModelProportion;for(let s=0;s<t.length;s++){const{x:h,y:o}=t[s].pos.scale(this._viewToModelProportion);this._ctxBalls.fillStyle=e.BALLS_COLORS[t[s].type],this._ctxBalls.beginPath(),this._ctxBalls.arc(h,o,i,0,2*Math.PI,!1),this._ctxBalls.fill()}}renderCue(t,i,s,h=0){t=t.scale(this._viewToModelProportion),i=i.scale(this._viewToModelProportion),s*=this._viewToModelProportion,h*=this._viewToModelProportion,this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight);const o=t.substract(i).getNormalized(),l=t.add(this.tablePos).add(o,s+this._initialSpace+h*this._maxSpace),r=l.add(o,this._cueLength);this._ctxCue.globalCompositeOperation="source-over",this._ctxCue.strokeStyle=e.CUE_COLOR,this._ctxCue.beginPath(),this._ctxCue.moveTo(l.x,l.y),this._ctxCue.lineTo(r.x,r.y),this._ctxCue.lineWidth=this._cueWidth,this._ctxCue.stroke(),this._ctxCue.closePath()}fadeOutCue(t=!0,e=1){t&&(this._fadeStop=!1),e-=.01,this._ctxCue.globalCompositeOperation="destination-in",this._ctxCue.fillStyle=`rgba(255, 255, 255, ${e})`,this._ctxCue.fillRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight),e>0?this._fadeStop?this._fadeStop=!1:requestAnimationFrame(this.fadeOutCue.bind(this,!1,e)):this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight)}fadeOutStop(){this._fadeStop=!0}get viewToModelProportion(){return this._viewToModelProportion}}class i{static RESTITUTION=.85;static FRICTION_KOEF=.03;static radius;static adjusted_friction_koef;_pos;_dir;_vel;_type;constructor(e,i="ordinary"){this._pos=e,this._dir=new t(0,0),this._vel=0,this._removed=!1,this._type=i}simulate(){this.move(),this.slowDown()}slowDown(){this._vel-=i.FRICTION_KOEF,this._vel<0&&(this._vel=0)}move(){this._pos=this._pos.add(this._dir,this._vel)}collide(t){let e=this.pos.substract(t.pos);const s=e.getLength();if(0===s||s>=2*i.radius)return;e=e.getNormalized();const h=(2*i.radius-s)/2;this.pos=this.pos.add(e,h),t.pos=t.pos.add(e,-h);const o=this.dir.scale(this.vel),l=t.dir.scale(t.vel),r=o.dot(e),a=l.dot(e),_=(r+a-(r-a)*i.RESTITUTION)/2,n=(r+a-(a-r)*i.RESTITUTION)/2,c=o.add(e,_-r),d=l.add(e,n-a);this.dir=c.getNormalized(),t.dir=d.getNormalized(),this.vel=c.getLength(),t.vel=d.getLength()}isInPocket(t,e){return this._pos.substract(t).getLength()<=e}get pos(){return this._pos}set pos(t){this._pos=t}get dir(){return this._dir}set dir(t){t.isNormal()?this._dir=t:this._dir=t.getNormalized()}get vel(){return this._vel}set vel(t){t<0&&(t*=-1,this.dir=this.dir.scale(-1)),this._vel=t}get type(){return this._type}set type(t){this._type=t}}class s{static RESTITUTION=.7;_x;_y;_width;_height;constructor(t,e,i,s){this._x=t,this._y=e,this._width=i,this._height=s}findNearestVertexPos(e){const i=new t(this._x,this._y),s=new t(this._x+this._width,this.y+this._height);return Math.abs(i.x-e.x)<Math.abs(s.x-e.x)?Math.abs(i.y-e.y)<Math.abs(s.y-e.y)?(console.log("topLeft"),{pos:i,horVector:new t(-1,0),vertVector:new t(0,-1)}):(console.log("bottomLeft"),{pos:new t(this._x,this._y+this._height),horVector:new t(-1,0),vertVector:new t(0,1)}):Math.abs(i.y-e.y)<Math.abs(s.y-e.y)?(console.log("topRight"),{pos:new t(this._x+this._width,this._y),horVector:new t(1,0),vertVector:new t(0,-1)}):(console.log("bottomRight"),{pos:s,horVector:new t(1,0),vertVector:new t(0,1)})}collide(t,e){const i=t.pos.add(t.dir,t.vel);if(this.isNextPosInBox(e,i))if(i.y>this._y&&i.y<this._y+this._height)t.dir.x*=-1,t.vel*=s.RESTITUTION,this.checkTrappedBall(t,e);else if(i.x>this._x&&i.x<this._x+this._width)t.dir.y*=-1,t.vel*=s.RESTITUTION,this.checkTrappedBall(t,e);else{console.log(t.dir,t.pos);const h=this.findNearestVertexPos(i),o=i.substract(h.pos),l=o.getLength();if(l>e)return;let r=o.getNormalized();Math.abs(h.horVector.x-r.x)>1?(console.log("hor normal change"),r=h.vertVector):Math.abs(h.vertVector.y-r.y)>1&&(console.log("vert normal change"),r=h.horVector);const a=2*t.dir.dot(r);t.dir=t.dir.substract(r.scale(a)),t.pos=t.pos.add(r,e-l),t.vel*=s.RESTITUTION}}checkTrappedBall(t,e){const i=t.pos.add(t.dir,t.vel);this.isNextPosInBox(e,i)&&(console.log("ball trap is avoided"),t.dir.x*=-1,t.dir.y*=-1)}isNextPosInBox(t,e){return e.x+t>this._x&&e.x-t<this._x+this._width&&e.y+t>this._y&&e.y-t<this._y+this._height}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}}class h{static WALL_WIDTH=80;static BALL_RADIUS=25;static TABLE_WIDTH=2048;static TABLE_HEIGHT=1024;static INTENDED_FPS=60;static MAX_HIT_POWER=30;static POCKET_RADIUS=40;static WALL_RESTITUTION=.65;_view;_balls;_walls;_pockets;_hitPower;_targetPos;_chosenBall;_isFirstHit;_isWaitingForHit;constructor(e){console.log("game"),this._view=e,i.radius=h.BALL_RADIUS,this._oldTime=0,this._fpsAdhustKoef=1,this._isWaitingForHit=!0,this._isFirstHit=!0,this._targetPos=new t(0,0),this.initPockets(),this.initWalls(),this.initBalls(),this._view.renderTable(),this._view.renderPockets(this._pockets,h.POCKET_RADIUS),this._view.renderWalls(this._walls.map((t=>({x:t.x,y:t.y,width:t.width,height:t.height})))),this._view.renderBalls(this._balls,i.radius)}testingStart(){this._isWaitingForHit=!1,this._chosenBall.dir=new t(-.6865867239941715,.6370479148137013),this._chosenBall.vel=10}initBalls(){this._balls=new Array(16);let e=2*i.radius,s=Math.sqrt(3*i.radius*i.radius),o=h.TABLE_WIDTH/3*2,l=h.TABLE_HEIGHT/2,r=0,a=0,_=0,n=1,c=2;this._balls[0]=new i(new t(h.TABLE_WIDTH/4,l),"main"),this.chosenBall=this._balls[0];for(let h=1;h<16;h++)this._balls[h]=new i(new t(o+r,l+a+_)),_+=e+1,h%n==0&&(n+=c,r+=s+1,a-=i.radius,_=0,c++)}initWalls(){const t=2*h.POCKET_RADIUS,e=h.TABLE_WIDTH,i=h.TABLE_HEIGHT,o=h.WALL_WIDTH,l=Math.sqrt(t*t/2)+o,r=(e-t-2*l)/2,a=i-2*l,_=l+r+t;this._walls=new Array(6),this._walls[0]=new s(l,0,r,o),this._walls[1]=new s(_,0,r,o),this._walls[2]=new s(l,i-o,r,o),this._walls[3]=new s(_,i-o,r,o),this._walls[4]=new s(0,l,o,a),this._walls[5]=new s(e-o,l,o,a)}initPockets(){const e=h.POCKET_RADIUS,i=h.TABLE_WIDTH,s=h.TABLE_HEIGHT,o=h.WALL_WIDTH;this._pockets=[],this._pockets[0]=new t(o,o),this._pockets[1]=new t(i/2,o-e),this._pockets[2]=new t(i-o,o),this._pockets[3]=new t(i-o,s-o),this._pockets[4]=new t(i/2,s-o+e),this._pockets[5]=new t(o,s-o)}async start(){let t=performance.now();const e=1e3/h.INTENDED_FPS;let i=0;for(;;){let s=await new Promise(requestAnimationFrame);s-t<e-i||(i=Math.min(e,i+s-t-e),t=s,this.run())}}run(){this._isWaitingForHit?(this._view.fadeOutStop(),this._view.renderCue(this.chosenBall.pos,this.targetPos,i.radius,this.hitPower)):(this.update(),this._view.renderBalls(this._balls,i.radius))}update(){let t,e=!0;t:for(let s=0;s<this._balls.length;s++){t=this._balls[s];for(let e=s+1;e<this._balls.length;e++)t.collide(this._balls[e]);for(let e of this._walls)e.collide(t,i.radius);t.simulate();for(let e of this._pockets)if(this.checkPocket(e,t)){if(this._balls.splice(s,1),!this._balls)return void this.endGame();this._chosenBall===t&&(this._chosenBall=this._balls[0]),s--;continue t}0!==t.vel&&(e=!1)}e&&(this._isWaitingForHit=!0,this._balls.length<2)&&this.endGame()}chooseBall(t){if(!this._isFirstHit)for(let e=0;e<this._balls.length;e++){if(this._balls[e].pos.substract(t).getLength()<=i.radius)return void(this._chosenBall=this._balls[e])}}hitBall(){!this._balls.includes(this._chosenBall)||this._hitPower<.05||(this._isWaitingForHit=!1,this._isFirstHit=!1,this._chosenBall.dir=this._targetPos.substract(this._chosenBall.pos),this._chosenBall.vel=this._hitPower*h.MAX_HIT_POWER,console.log("model hit power: "+this._chosenBall.vel),this._view.renderCue(this.chosenBall.pos,this.targetPos,i.radius),this._view.fadeOutCue())}checkPocket(t,e){return e.pos.substract(t).getLength()<h.POCKET_RADIUS}endGame(){this.restart()}restart(){this.initBalls(),this._isWaitingForHit=!0,this._isFirstHit=!0,this._view.renderBalls(this._balls,i.radius)}set targetPos(t){this._targetPos=t}get targetPos(){return this._targetPos}set chosenBall(t){this._chosenBall=t}get chosenBall(){return this._chosenBall}set hitPower(t){t<0?t=0:t>1&&(t=1),this._hitPower=t}get hitPower(){return this._hitPower}set isWaitingForHit(t){this._isWaitingForHit=t}get isWaitingForHit(){return this._isWaitingForHit}get canvasAdjKoef(){return this._canvasAdjKoef}}class o{static HIT_POWER_TRASHOLD=.05;_model;_canvasRect;_modelToControlProportion;constructor(t,e,i){this._model=t,this._canvasRect=e,this._modelToControlProportion=1/i,this.initMouseControl()}initMouseControl(){let e,i=null,s=new t(0,0);window.addEventListener("mousemove",(h=>{const o=new t(h.clientX-this._canvasRect.x,h.clientY-this._canvasRect.y);i?(s=o.substract(i),this._model.hitPower=4*this._modelToControlProportion*e.dot(s)/this._canvasRect.width):(s=new t(0,0),this._model.targetPos=o.scale(this._modelToControlProportion))})),window.addEventListener("mousedown",(s=>{this._model.isWaitingForHit&&(i=new t(s.clientX-this._canvasRect.x,s.clientY-this._canvasRect.y),e=this._model.chosenBall.pos.scale(1/this._modelToControlProportion).substract(i).getNormalized(),window.addEventListener("mouseup",(()=>{console.log("control hit power: "+this._model.hitPower),this._model.hitPower<o.HIT_POWER_TRASHOLD?this._model.chooseBall(i.scale(this._modelToControlProportion)):this._model.hitBall(),this._model.hitPower=0,i=null}),{once:!0}))})),document.getElementById("restart").addEventListener("click",(()=>{this._model.restart()}))}}const l=document.getElementById("canvas-table"),r=document.getElementById("canvas-balls"),a=document.getElementById("canvas-cue"),_=l.getBoundingClientRect(),n=_.width,c=_.height;l.width=n,l.height=c,r.width=n,r.height=c,a.width=window.innerWidth,a.height=window.innerHeight,async function(){const t=new e(l,r,a);await t.init(l,a,h.TABLE_WIDTH);const i=new h(t);new o(i,_,t.viewToModelProportion),i.start()}()})();