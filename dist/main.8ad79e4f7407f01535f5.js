(()=>{"use strict";class t{_x;_y;constructor(t,e){this._x=t,this._y=e}getLength(){return Math.sqrt(this._x*this._x+this._y*this._y)}isNormal(){return 1===this.getLength()}getNormalized(){const e=this.getLength();if(!e)return new t(0,0);const i=this._x/e,s=this._y/e;return new t(i,s)}add(e,i=1){return new t(this._x+e.x*i,this._y+e.y*i)}substract(e){return new t(this._x-e.x,this._y-e.y)}scale(e){return new t(this._x*e,this._y*e)}dot(t){return this._x*t.x+this._y*t.y}getVectorInRotatedBasis(e){return new t(this._x*Math.cos(e)+this._y*Math.sin(e),this._x*-Math.sin(e)+this._y*Math.cos(e))}isZero(){return 0===this._x&&0===this._y}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}}class e{static CUE_COLOR="#2f1212";static DECOR_COLOR="#CFB725";static TABLE_COLOR="#145127";static BALLS_COLORS={main:"#670730",ordinary:"#D9D9C3"};static POCKET_COLORS=["#181111","#222222","#CFB725"];static WALL_COLORS=["#A47461","#C48B68","#733D29","#5E2D19","#60311D","#60311D","#60311D","#60311D","#5E2D1B","#411B10","#238E3B","#1D8C39","#238E3B","#177834"];static SHADOW_SHIFT=1.3;_sprites={cue:void 0,ball:void 0,shadow:void 0};_ctxCue;_ctxBalls;_cueWidth;_maxSpace;_ctxTable;_fadeStop;_tablePos;_cueLength;_tableWidth;_tableHeight;_initialSpace;_fadeGenerator;_cueSpaceWidth;_cueSpaceHeight;_animatePocketHitStop;_viewToModelProportion;_animatePocketHitGenerator;constructor(t,e,i){this._ctxTable=t.getContext("2d"),this._ctxCue=i.getContext("2d"),this._ctxBalls=e.getContext("2d"),this._fadeGenerator=this.fadeOutCue(),this._animatePocketHitGenerator=this.animatePocketHit()}async init(e,i,s){const o=e.getBoundingClientRect();this._cueSpaceWidth=i.width,this._cueSpaceHeight=i.height,this._tableWidth=e.width,this._tableHeight=e.height,this._viewToModelProportion=this._tableWidth/s,this._tablePos=new t(o.left,o.top),this._cueLength=this._tableHeight,this._cueWidth=this._cueLength/32,this._initialSpace=this._cueWidth,this._maxSpace=20*this._initialSpace,this._animatePocketHitStop=!0,this.__fadeStop=!0,await this.loadSprites()}loadSprites(){return new Promise((t=>{const e=Object.keys(this._sprites);let i=0;const s=o=>{this._sprites[o]=new Image,this._sprites[o].onload=()=>{i==e.length-1?t():s(e[++i])},this._sprites[o].src=`./img/${o}.png`};s(e[i])}))}renderTable(t){this._ctxTable.clearRect(0,0,this._tableWidth,this._tableHeight),this._ctxTable.fillStyle=e.TABLE_COLOR,this._ctxTable.roundRect(0,0,this._tableWidth,this._tableHeight,t),this._ctxTable.fill()}renderPockets(t,i,s){const o=i*this._viewToModelProportion,h=s*this._viewToModelProportion,a=.3*o;this._ctxTable.lineWidth=a;const l=(t,i,s)=>{const a=-Math.PI*(s/2-1/4);this._ctxTable.fillStyle=e.TABLE_COLOR,this._ctxTable.translate(t,i),this._ctxTable.rotate(-a),this._ctxTable.translate(-t,-i),this._ctxTable.fillRect(t,i-o,2*h,2*o),this._ctxTable.setTransform(1,0,0,1,0,0),this._ctxTable.fillStyle=e.POCKET_COLORS[0],this._ctxTable.beginPath(),this._ctxTable.arc(t,i,o,0,2*Math.PI,!1),this._ctxTable.fill(),this._ctxTable.beginPath(),this._ctxTable.strokeStyle=e.POCKET_COLORS[2],this._ctxTable.lineCap="round";const l=s%1==0?.3:.5;this._ctxTable.arc(t,i,o,(s+l)*Math.PI/2,Math.PI*(s-l+3)/2,!1),this._ctxTable.stroke()};for(let e=0;e<t.length;e++){let i=e>3?2*e+1.5:e+1;l(t[e].x*this._viewToModelProportion,t[e].y*this._viewToModelProportion,i)}}renderWalls(t,i,s){const o=s*this._viewToModelProportion/e.WALL_COLORS.length;let h=o/2;this._ctxTable.lineWidth=o+1;for(let t=0;t<e.WALL_COLORS.length;t++,h+=o){this._ctxTable.strokeStyle=e.WALL_COLORS[t],this._ctxTable.beginPath();let s=.5*(i-h);s=s>0?s:0,this._ctxTable.roundRect(h,h,this._tableWidth-2*h,this._tableHeight-2*h,s),this._ctxTable.stroke()}const a=s*this._viewToModelProportion/15;for(let i of t){if(i.rotate)continue;const t=i.x*this._viewToModelProportion,s=i.y*this._viewToModelProportion,o=i.width*this._viewToModelProportion/4,h=i.height*this._viewToModelProportion/2;this._ctxTable.fillStyle=e.DECOR_COLOR;for(let e=1;e<=3;e++){let l=t+o*e,r=s+h;i.width<i.height&&(l=t+i.width*this._viewToModelProportion/2,r=s+i.height*this._viewToModelProportion/4*e),this._ctxTable.beginPath(),this._ctxTable.arc(l,r,a,0,2*Math.PI),this._ctxTable.fill()}}}renderBalls(t,i){this._ctxBalls.clearRect(0,0,this._tableWidth,this._tableHeight);let s=[];const o=2*(i*=this._viewToModelProportion),h=i*e.SHADOW_SHIFT;this._ctxBalls.globalCompositeOperation="source-over";for(let e=0;e<t.length;e++){const{x:a,y:l}=t[e].pos.scale(this._viewToModelProportion);s.push({x:a,y:l}),this._ctxBalls.drawImage(this._sprites.shadow,a-i,l-o+h,o,o)}for(let s=0;s<t.length;s++){const{x:h,y:a}=t[s].pos.scale(this._viewToModelProportion);this._ctxBalls.fillStyle=e.BALLS_COLORS[t[s].type],this._ctxBalls.beginPath(),this._ctxBalls.arc(h,a,i,0,2*Math.PI,!1),this._ctxBalls.fill(),this._ctxBalls.drawImage(this._sprites.ball,h-i,a-i,o,o)}}renderCue(e,i,s,o=0){e=e.scale(this._viewToModelProportion),i=i.scale(this._viewToModelProportion),s*=this._viewToModelProportion,o*=this._viewToModelProportion;const h=e.substract(i).getNormalized(),a=new t(-h.y,h.x),l=e.add(this._tablePos).add(h,s+this._initialSpace+o*this._maxSpace+this._cueLength).add(a,this._cueWidth/2);let r=Math.acos(-h.x);h.y>0&&(r*=-1),this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight),this._ctxCue.globalCompositeOperation="source-over",this._ctxCue.translate(l.x,l.y),this._ctxCue.rotate(r),this._ctxCue.translate(-l.x,-l.y),this._ctxCue.drawImage(this._sprites.cue,l.x,l.y,this._cueLength,this._cueWidth),this._ctxCue.setTransform(1,0,0,1,0,0)}fadeOutStart(){this._fadeStop=!1}fadeOutStop(){this._fadeStop=!0,this._fadeGenerator=this.fadeOutCue()}*fadeOutCue(){let t=1;for(;;){if(t-=.01,this._ctxCue.globalCompositeOperation="destination-in",this._ctxCue.fillStyle=`rgba(255, 255, 255, ${t})`,this._ctxCue.fillRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight),!(t>0)||this._fadeStop)return void this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight);yield}}animatePocketHitStart(t,e,i){this._animatePocketHitStop=!1,this._animatePocketHitGenerator=this.animatePocketHit(t,e,i)}animatePocketHitStop(){this._animatePocketHitStop=!0}*animatePocketHit(t,i,s){s*=this._viewToModelProportion,t=t.scale(this._viewToModelProportion);let o=i.pos.scale(this._viewToModelProportion);const h=t.substract(o).getNormalized(),a=2*s;let l=0,r=.5*i.vel;r>20&&(r=20),r<.5&&(r=.5);const _=s*e.SHADOW_SHIFT;for(;;){if(o===t)l+=.05,this._ctxBalls.globalCompositeOperation="destination-out",this._ctxBalls.fillStyle=`rgba(255, 255, 255, ${l})`,this._ctxBalls.fillRect(o.x-s,o.y-s,a,a+_);else{this._ctxBalls.clearRect(o.x-s-1,o.y-s-1,a+2,a+_+2);const l=t.substract(o).getNormalized();o=o.add(h,r),(Math.abs(l.x-h.x)>1||Math.abs(l.y-h.y)>1)&&(o=t),this._ctxBalls.globalCompositeOperation="source-over",this._ctxBalls.drawImage(this._sprites.shadow,o.x-s,o.y-a+_,a,a),this._ctxBalls.fillStyle=e.BALLS_COLORS[i.type],this._ctxBalls.beginPath(),this._ctxBalls.arc(o.x,o.y,s,0,2*Math.PI,!1),this._ctxBalls.fill(),this._ctxBalls.drawImage(this._sprites.ball,o.x-s,o.y-s,a,a)}if(!(l<1))return void this._ctxBalls.clearRect(o.x-s-1,o.y-s-1,a+2,a+_+2);yield}}animate(){this._fadeStop||this._fadeGenerator.next().done&&this.fadeOutStop(),this._animatePocketHitStop||this._animatePocketHitGenerator.next().done&&this.animatePocketHitStop()}get viewToModelProportion(){return this._viewToModelProportion}}class i{static RESTITUTION=.8;static FRICTION_KOEF=.03;static radius;static adjusted_friction_koef;_pos;_dir;_vel;_type;constructor(e,i="ordinary"){this._pos=e,this._dir=new t(0,0),this._vel=0,this._removed=!1,this._type=i}simulate(){this.move(),this.slowDown()}slowDown(){this._vel-=i.FRICTION_KOEF,this._vel<0&&(this._vel=0)}move(){this._pos=this._pos.add(this._dir,this._vel)}collide(t){let e=this.pos.substract(t.pos);const s=e.getLength();if(0===s||s>=2*i.radius)return;e=e.getNormalized();const o=(2*i.radius-s)/2;this.pos=this.pos.add(e,o),t.pos=t.pos.add(e,-o);const h=this.dir.scale(this.vel),a=t.dir.scale(t.vel),l=h.dot(e),r=a.dot(e),_=(l+r-(l-r)*i.RESTITUTION)/2,n=(l+r-(r-l)*i.RESTITUTION)/2,c=h.add(e,_-l),d=a.add(e,n-r);this.dir=c.getNormalized(),t.dir=d.getNormalized(),this.vel=c.getLength(),t.vel=d.getLength()}isInPocket(t,e){return this._pos.substract(t).getLength()<=e}get pos(){return this._pos}set pos(t){this._pos=t}get dir(){return this._dir}set dir(t){t.isNormal()?this._dir=t:this._dir=t.getNormalized()}get vel(){return this._vel}set vel(t){t<0&&(t*=-1,this.dir=this.dir.scale(-1)),this._vel=t}get type(){return this._type}set type(t){this._type=t}}class s{static RESTITUTION=.7;_x;_y;_width;_height;_rotate;constructor(t,e,i,s,o=0){this._x=t,this._y=e,this._width=i,this._height=s,this._rotate=o}findNearestVertexPos(e,i){const s=new t(i.x,i.y),o=new t(i.x+this._width,this.y+this._height);return Math.abs(s.x-e.x)<Math.abs(o.x-e.x)?Math.abs(s.y-e.y)<Math.abs(o.y-e.y)?{pos:s,horVector:new t(-1,0),vertVector:new t(0,-1)}:{pos:new t(i.x,i.y+this._height),horVector:new t(-1,0),vertVector:new t(0,1)}:Math.abs(s.y-e.y)<Math.abs(o.y-e.y)?{pos:new t(i.x+this._width,i.y),horVector:new t(1,0),vertVector:new t(0,-1)}:{pos:o,horVector:new t(1,0),vertVector:new t(0,1)}}collide(e,i){let o,h,a,l=!1;this._rotate?(l=!0,o=e.pos.getVectorInRotatedBasis(this._rotate),h=e.dir.getVectorInRotatedBasis(this._rotate),a=new t(this._x,this._y).getVectorInRotatedBasis(this._rotate)):(o=e.pos,h=e.dir,a=new t(this._x,this._y));const r=o.add(h,e.vel);if(this.isNextPosInBox(i,r,a)){if(r.y>a.y&&r.y<a.y+this._height)h.x*=-1,e.vel*=s.RESTITUTION,this.checkTrappedBall(o,h,e.vel,i,a);else if(r.x>a.x&&r.x<a.x+this._width)h.y*=-1,e.vel*=s.RESTITUTION,this.checkTrappedBall(o,h,e.vel,i,a);else{const t=this.findNearestVertexPos(r,a),l=r.substract(t.pos),_=l.getLength();if(_>i)return;let n=l.getNormalized();Math.abs(t.horVector.x-n.x)>1?n=t.vertVector:Math.abs(t.vertVector.y-n.y)>1&&(n=t.horVector);const c=2*h.dot(n);h=h.substract(n.scale(c)),o=o.add(n,i-_),e.vel*=s.RESTITUTION}this._rotate?(e.pos=o.getVectorInRotatedBasis(-this._rotate),e.dir=h.getVectorInRotatedBasis(-this._rotate)):(e.pos=o,e.dir=h)}}checkTrappedBall(t,e,i,s,o){const h=t.add(e,i);this.isNextPosInBox(s,h,o)&&(e.x*=-1,e.y*=-1)}isNextPosInBox(t,e,i){return e.x+t>i.x&&e.x-t<i.x+this._width&&e.y+t>i.y&&e.y-t<i.y+this._height}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get rotate(){return this._rotate}set rotate(t){this._rotate=t}}class o{static WALL_WIDTH=80;static BALL_RADIUS=20;static TABLE_WIDTH=2048;static TABLE_HEIGHT=1024;static INTENDED_FPS=60;static MAX_HIT_POWER=30;static POCKET_RADIUS=35;static WALL_RESTITUTION=.65;static POCKET_SHIFT_KOEF=.5;_view;_balls;_walls;_pockets;_hitPower;_targetPos;_chosenBall;_isFirstHit;_isWaitingForHit;constructor(e){this._view=e,i.radius=o.BALL_RADIUS,this._oldTime=0,this._fpsAdhustKoef=1,this._isWaitingForHit=!0,this._isFirstHit=!0,this._hitPower=0,this._targetPos=new t(0,0),this.initPockets(),this.initWalls(),this.initBalls(),this.renderGame()}renderGame(){this._view.renderTable(o.POCKET_RADIUS),this._view.renderWalls(this._walls,o.POCKET_RADIUS,o.WALL_WIDTH),this._view.renderPockets(this._pockets,o.POCKET_RADIUS,o.WALL_WIDTH,o.POCKET_SHIFT_KOEF),this._view.renderBalls(this._balls,i.radius)}testingStart(){this._isWaitingForHit=!1,this._chosenBall.dir=new t(-.6865867239941715,.6370479148137013),this._chosenBall.vel=10}initBalls(){this._balls=new Array(16);let e=2*i.radius,s=Math.sqrt(3*i.radius*i.radius),h=o.TABLE_WIDTH/3*2,a=o.TABLE_HEIGHT/2,l=0,r=0,_=0,n=1,c=2;this._balls[0]=new i(new t(o.TABLE_WIDTH/4,a),"main"),this.chosenBall=this._balls[0];for(let o=1;o<16;o++)this._balls[o]=new i(new t(h+l,a+r+_)),_+=e+1,o%n==0&&(n+=c,l+=s+1,r-=i.radius,_=0,c++)}initWalls(){const t=2*o.POCKET_RADIUS,e=o.TABLE_WIDTH,i=o.TABLE_HEIGHT,h=o.WALL_WIDTH,a=2*h,l=Math.sqrt(t*t/2)+h,r=(e-t-2*l)/2,_=i-2*l,n=l+r+t;this._walls=[],this._walls[0]=new s(l,0,r,h),this._walls[1]=new s(n,0,r,h),this._walls[2]=new s(l,i-h,r,h),this._walls[3]=new s(n,i-h,r,h),this._walls[4]=new s(0,l,h,_),this._walls[5]=new s(e-h,l,h,_),this._walls[6]=new s(h,l,a,a,3*Math.PI/4),this._walls[7]=new s(l,h,a,a,3*-Math.PI/4),this._walls[8]=new s(e-h,l,a,a,-Math.PI/4),this._walls[9]=new s(e-l,h,a,a,3*-Math.PI/4),this._walls[10]=new s(e-h,i-l,a,a,-Math.PI/4),this._walls[11]=new s(e-l,i-h,a,a,Math.PI/4),this._walls[12]=new s(h,i-l,a,a,3*Math.PI/4),this._walls[13]=new s(l,i-h,a,a,Math.PI/4)}initPockets(){const e=o.POCKET_RADIUS*(1+o.POCKET_SHIFT_KOEF),i=o.TABLE_WIDTH,s=o.TABLE_HEIGHT;this._pockets=[],this._pockets[0]=new t(e,e),this._pockets[1]=new t(i-e,e),this._pockets[2]=new t(i-e,s-e),this._pockets[3]=new t(e,s-e),this._pockets[4]=new t(i/2,e),this._pockets[5]=new t(i/2,s-e)}async start(){let t=performance.now();const e=1e3/o.INTENDED_FPS;let i=0;for(;;){let s=await new Promise(requestAnimationFrame);s-t<e-i||(i=Math.min(e,i+s-t-e),t=s,this.run())}}run(){this._isWaitingForHit?(this._view.fadeOutStop(),this._view.renderCue(this._chosenBall.pos,this._targetPos,i.radius,this._hitPower)):(this.update(),this._view.renderBalls(this._balls,i.radius)),this._view.animate()}update(){let t,e=!0;t:for(let s=0;s<this._balls.length;s++){t=this._balls[s];for(let e=s+1;e<this._balls.length;e++)t.collide(this._balls[e]);for(let e of this._walls)e.collide(t,i.radius);t.simulate();for(let e of this._pockets)if(this.checkPocket(e,t)){if(this._view.animatePocketHitStart(e,t,i.radius),this._balls.splice(s,1),!this._balls)return void this.endGame();this._chosenBall===t&&(this._chosenBall=this._balls[0]),s--;continue t}0!==t.vel&&(e=!1)}e&&(this._isWaitingForHit=!0,this._balls.length<2)&&this.endGame()}chooseBall(t){if(!this._isFirstHit)for(let e=0;e<this._balls.length;e++){if(this._balls[e].pos.substract(t).getLength()<=i.radius)return void(this._chosenBall=this._balls[e])}}hitBall(){!this._balls.includes(this._chosenBall)||this._hitPower<.05||(this._isWaitingForHit=!1,this._isFirstHit=!1,this._chosenBall.dir=this._targetPos.substract(this._chosenBall.pos),this._chosenBall.vel=this._hitPower*o.MAX_HIT_POWER,this._view.renderCue(this.chosenBall.pos,this.targetPos,i.radius),this._view.fadeOutStart())}checkPocket(t,e){return e.pos.substract(t).getLength()<o.POCKET_RADIUS}endGame(){this.restart()}restart(){this.initBalls(),this._isWaitingForHit=!0,this._isFirstHit=!0,this._hitPower=0,this._view.renderBalls(this._balls,i.radius)}set targetPos(t){this._targetPos=t}get targetPos(){return this._targetPos}set chosenBall(t){this._chosenBall=t}get chosenBall(){return this._chosenBall}set hitPower(t){t<0?t=0:t>1&&(t=1),this._hitPower=t}get hitPower(){return this._hitPower}set isWaitingForHit(t){this._isWaitingForHit=t}get isWaitingForHit(){return this._isWaitingForHit}get canvasAdjKoef(){return this._canvasAdjKoef}}class h{static HIT_POWER_TRASHOLD=.05;_model;_canvasRect;_mouseMoveFunction;_mouseDownFunction;_modelToControlProportion;constructor(t,e,i){this._model=t,this._canvasRect=e.getBoundingClientRect(),this._modelToControlProportion=1/i,this.initMouseControl()}resizeInit(t,e){this._canvasRect=t.getBoundingClientRect(),this._modelToControlProportion=1/e}initMouseControl(){let e,i=null,s=new t(0,0);window.addEventListener("mousemove",(o=>{const h=new t(o.clientX-this._canvasRect.x,o.clientY-this._canvasRect.y);i?(s=h.substract(i),this._model.hitPower=4*this._modelToControlProportion*e.dot(s)/this._canvasRect.width):(s=new t(0,0),this._model.targetPos=h.scale(this._modelToControlProportion))})),window.addEventListener("mousedown",(s=>{this._model.isWaitingForHit&&(i=new t(s.clientX-this._canvasRect.x,s.clientY-this._canvasRect.y),e=this._model.chosenBall.pos.scale(1/this._modelToControlProportion).substract(i).getNormalized(),window.addEventListener("mouseup",(()=>{this._model.hitPower<h.HIT_POWER_TRASHOLD?this._model.chooseBall(i.scale(this._modelToControlProportion)):this._model.hitBall(),this._model.hitPower=0,i=null}),{once:!0}))})),document.getElementById("restart").addEventListener("click",(()=>{this._model.restart()}))}mouseMoveFunction(){}mouseDownFunction(){}}const a=document.getElementById("canvas-table"),l=document.getElementById("canvas-balls"),r=document.getElementById("canvas-cue");let _,n,c;const d=function(){const t=a.getBoundingClientRect(),e=t.width,i=t.height;a.width=e,a.height=i,l.width=e,l.height=i,r.width=window.innerWidth,r.height=window.innerHeight};window.addEventListener("resize",(async()=>{d(),await _.init(a,r,o.TABLE_WIDTH),n.renderGame(),c.resizeInit(a,_.viewToModelProportion)})),async function(){d(),_=new e(a,l,r),await _.init(a,r,o.TABLE_WIDTH),n=new o(_),c=new h(n,a,_.viewToModelProportion),n.start()}()})();