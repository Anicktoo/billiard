(()=>{var t={260:()=>{(()=>{"use strict";function t(t,i,s,o,r){if(![t,i,s,o].every((t=>Number.isFinite(t))))return;let h,n,a,l;if(4===(r=function(t){const e=typeof t;if("undefined"===e||null===t)return[0];if("function"===e)return[NaN];if("object"===e)return"function"==typeof t[Symbol.iterator]?[...t].map((t=>{const e=typeof t;return"undefined"===e||null===t?0:"function"===e?NaN:"object"===e?d(t):u(t)})):[d(t)];return[u(t)]}(r)).length)h=p(r[0]),n=p(r[1]),a=p(r[2]),l=p(r[3]);else if(3===r.length)h=p(r[0]),n=p(r[1]),l=p(r[1]),a=p(r[2]);else if(2===r.length)h=p(r[0]),a=p(r[0]),n=p(r[1]),l=p(r[1]);else{if(1!==r.length)throw new RangeError(`${e(this)} ${r.length} is not a valid size for radii sequence.`);h=p(r[0]),n=p(r[0]),a=p(r[0]),l=p(r[0])}const _=[h,n,a,l],c=_.find((({x:t,y:e})=>t<0||e<0));c?.x<0&&c.x;if(!_.some((({x:t,y:e})=>!Number.isFinite(t)||!Number.isFinite(e)))){if(c)throw new RangeError(`${e(this)} Radius value ${c} is negative.`);!function(t){const[e,i,r,h]=t,n=[Math.abs(s)/(e.x+i.x),Math.abs(o)/(i.y+r.y),Math.abs(s)/(r.x+h.x),Math.abs(o)/(e.y+h.y)],a=Math.min(...n);if(a<=1)for(const e of t)e.x*=a,e.y*=a}(_),s<0&&o<0?(this.moveTo(t-h.x,i),this.ellipse(t+s+n.x,i-n.y,n.x,n.y,0,1.5*-Math.PI,-Math.PI),this.ellipse(t+s+a.x,i+o+a.y,a.x,a.y,0,-Math.PI,-Math.PI/2),this.ellipse(t-l.x,i+o+l.y,l.x,l.y,0,-Math.PI/2,0),this.ellipse(t-h.x,i-h.y,h.x,h.y,0,0,-Math.PI/2)):s<0?(this.moveTo(t-h.x,i),this.ellipse(t+s+n.x,i+n.y,n.x,n.y,0,-Math.PI/2,-Math.PI,1),this.ellipse(t+s+a.x,i+o-a.y,a.x,a.y,0,-Math.PI,1.5*-Math.PI,1),this.ellipse(t-l.x,i+o-l.y,l.x,l.y,0,Math.PI/2,0,1),this.ellipse(t-h.x,i+h.y,h.x,h.y,0,0,-Math.PI/2,1)):o<0?(this.moveTo(t+h.x,i),this.ellipse(t+s-n.x,i-n.y,n.x,n.y,0,Math.PI/2,0,1),this.ellipse(t+s-a.x,i+o+a.y,a.x,a.y,0,0,-Math.PI/2,1),this.ellipse(t+l.x,i+o+l.y,l.x,l.y,0,-Math.PI/2,-Math.PI,1),this.ellipse(t+h.x,i-h.y,h.x,h.y,0,-Math.PI,1.5*-Math.PI,1)):(this.moveTo(t+h.x,i),this.ellipse(t+s-n.x,i+n.y,n.x,n.y,0,-Math.PI/2,0),this.ellipse(t+s-a.x,i+o-a.y,a.x,a.y,0,0,Math.PI/2),this.ellipse(t+l.x,i+o-l.y,l.x,l.y,0,Math.PI/2,Math.PI),this.ellipse(t+h.x,i+h.y,h.x,h.y,0,Math.PI,1.5*Math.PI)),this.closePath(),this.moveTo(t,i)}function d(t){const{x:e,y:i,z:s,w:o}=t;return{x:e,y:i,z:s,w:o}}function u(t){return+t}function p(t){const e=u(t);return Number.isFinite(e)?{x:e,y:e}:Object(t)===t?{x:u(t.x??0),y:u(t.y??0)}:{x:NaN,y:NaN}}}function e(t){return`Failed to execute 'roundRect' on '${function(t){return Object(t)===t&&t instanceof Path2D?"Path2D":t instanceof globalThis?.CanvasRenderingContext2D?"CanvasRenderingContext2D":t instanceof globalThis?.OffscreenCanvasRenderingContext2D?"OffscreenCanvasRenderingContext2D":t?.constructor.name||t}(t)}':`}Path2D.prototype.roundRect??=t,globalThis.CanvasRenderingContext2D&&(globalThis.CanvasRenderingContext2D.prototype.roundRect??=t),globalThis.OffscreenCanvasRenderingContext2D&&(globalThis.OffscreenCanvasRenderingContext2D.prototype.roundRect??=t)})()}},e={};function i(s){var o=e[s];if(void 0!==o)return o.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,i),r.exports}(()=>{"use strict";i(260);function t(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class e{constructor(e,i){t(this,"_x",void 0),t(this,"_y",void 0),this._x=e,this._y=i}getLength(){return Math.sqrt(this._x*this._x+this._y*this._y)}isNormal(){return 1===this.getLength()}getNormalized(){const t=this.getLength();if(!t)return new e(0,0);const i=this._x/t,s=this._y/t;return new e(i,s)}add(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new e(this._x+t.x*i,this._y+t.y*i)}substract(t){return new e(this._x-t.x,this._y-t.y)}scale(t){return new e(this._x*t,this._y*t)}dot(t){return this._x*t.x+this._y*t.y}getVectorInRotatedBasis(t){return new e(this._x*Math.cos(t)+this._y*Math.sin(t),this._x*-Math.sin(t)+this._y*Math.cos(t))}isZero(){return 0===this._x&&0===this._y}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}}function s(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class o{constructor(t,e,i){s(this,"_sprites",{cue:void 0,ball:void 0,shadow:void 0}),s(this,"_ctxCue",void 0),s(this,"_ctxBalls",void 0),s(this,"_cueWidth",void 0),s(this,"_maxSpace",void 0),s(this,"_ctxTable",void 0),s(this,"_fadeStop",void 0),s(this,"_tablePos",void 0),s(this,"_cueLength",void 0),s(this,"_tableWidth",void 0),s(this,"_tableHeight",void 0),s(this,"_initialSpace",void 0),s(this,"_fadeGenerator",void 0),s(this,"_cueSpaceWidth",void 0),s(this,"_cueSpaceHeight",void 0),s(this,"_animatePocketHitStop",void 0),s(this,"_viewToModelProportion",void 0),s(this,"_animatePocketHitGenerator",void 0),this._ctxTable=t.getContext("2d"),this._ctxCue=i.getContext("2d"),this._ctxBalls=e.getContext("2d"),this._fadeGenerator=this.fadeOutCue(),this._animatePocketHitGenerator=this.animatePocketHit()}async init(t,i,s){const o=t.getBoundingClientRect();this._cueSpaceWidth=i.width,this._cueSpaceHeight=i.height,this._tableWidth=t.width,this._tableHeight=t.height,this._viewToModelProportion=this._tableWidth/s,this._tablePos=new e(o.left,o.top),this._cueLength=this._tableHeight,this._cueWidth=this._cueLength/32,this._initialSpace=this._cueWidth,this._maxSpace=20*this._initialSpace,this._animatePocketHitStop=!0,this.__fadeStop=!0,await this.loadSprites()}loadSprites(){return new Promise((t=>{const e=Object.keys(this._sprites);let i=0;const s=o=>{this._sprites[o]=new Image,this._sprites[o].onload=()=>{i==e.length-1?t():s(e[++i])},this._sprites[o].src="./img/".concat(o,".png")};s(e[i])}))}renderTable(t){this._ctxTable.clearRect(0,0,this._tableWidth,this._tableHeight),this._ctxTable.fillStyle=o.TABLE_COLOR,this._ctxTable.roundRect(0,0,this._tableWidth,this._tableHeight,t),this._ctxTable.fill()}renderPockets(t,e,i){const s=e*this._viewToModelProportion,r=i*this._viewToModelProportion,h=.3*s;this._ctxTable.lineWidth=h;const n=(t,e,i)=>{const h=-Math.PI*(i/2-1/4);this._ctxTable.fillStyle=o.TABLE_COLOR,this._ctxTable.translate(t,e),this._ctxTable.rotate(-h),this._ctxTable.translate(-t,-e),this._ctxTable.fillRect(t,e-s,2*r,2*s),this._ctxTable.setTransform(1,0,0,1,0,0),this._ctxTable.fillStyle=o.POCKET_COLORS[0],this._ctxTable.beginPath(),this._ctxTable.arc(t,e,s,0,2*Math.PI,!1),this._ctxTable.fill(),this._ctxTable.beginPath(),this._ctxTable.strokeStyle=o.POCKET_COLORS[2],this._ctxTable.lineCap="round";const n=i%1==0?.3:.5;this._ctxTable.arc(t,e,s,(i+n)*Math.PI/2,Math.PI*(i-n+3)/2,!1),this._ctxTable.stroke()};for(let e=0;e<t.length;e++){let i=e>3?2*e+1.5:e+1;n(t[e].x*this._viewToModelProportion,t[e].y*this._viewToModelProportion,i)}}renderWalls(t,e,i){const s=i*this._viewToModelProportion/o.WALL_COLORS.length;let r=s/2;this._ctxTable.lineWidth=s+1;for(let t=0;t<o.WALL_COLORS.length;t++,r+=s){this._ctxTable.strokeStyle=o.WALL_COLORS[t],this._ctxTable.beginPath();let i=.5*(e-r);i=i>0?i:0,this._ctxTable.roundRect(r,r,this._tableWidth-2*r,this._tableHeight-2*r,i),this._ctxTable.stroke()}const h=i*this._viewToModelProportion/15;for(let e of t){if(e.rotate)continue;const t=e.x*this._viewToModelProportion,i=e.y*this._viewToModelProportion,s=e.width*this._viewToModelProportion/4,r=e.height*this._viewToModelProportion/2;this._ctxTable.fillStyle=o.DECOR_COLOR;for(let o=1;o<=3;o++){let n=t+s*o,a=i+r;e.width<e.height&&(n=t+e.width*this._viewToModelProportion/2,a=i+e.height*this._viewToModelProportion/4*o),this._ctxTable.beginPath(),this._ctxTable.arc(n,a,h,0,2*Math.PI),this._ctxTable.fill()}}}renderBalls(t,e){this._ctxBalls.clearRect(0,0,this._tableWidth,this._tableHeight);let i=[];const s=2*(e*=this._viewToModelProportion),r=e*o.SHADOW_SHIFT;this._ctxBalls.globalCompositeOperation="source-over";for(let o=0;o<t.length;o++){const{x:h,y:n}=t[o].pos.scale(this._viewToModelProportion);i.push({x:h,y:n}),this._ctxBalls.drawImage(this._sprites.shadow,h-e,n-s+r,s,s)}for(let i=0;i<t.length;i++){const{x:r,y:h}=t[i].pos.scale(this._viewToModelProportion);this._ctxBalls.fillStyle=o.BALLS_COLORS[t[i].type],this._ctxBalls.beginPath(),this._ctxBalls.arc(r,h,e,0,2*Math.PI,!1),this._ctxBalls.fill(),this._ctxBalls.drawImage(this._sprites.ball,r-e,h-e,s,s)}}renderCue(t,i,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;t=t.scale(this._viewToModelProportion),i=i.scale(this._viewToModelProportion),s*=this._viewToModelProportion,o*=this._viewToModelProportion;const r=t.substract(i).getNormalized(),h=new e(-r.y,r.x),n=t.add(this._tablePos).add(r,s+this._initialSpace+o*this._maxSpace+this._cueLength).add(h,this._cueWidth/2);let a=Math.acos(-r.x);r.y>0&&(a*=-1),this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight),this._ctxCue.globalCompositeOperation="source-over",this._ctxCue.translate(n.x,n.y),this._ctxCue.rotate(a),this._ctxCue.translate(-n.x,-n.y),this._ctxCue.drawImage(this._sprites.cue,n.x,n.y,this._cueLength,this._cueWidth),this._ctxCue.setTransform(1,0,0,1,0,0)}showAimLine(t,e,i,s){const r=t.pos.add(i,s+1).scale(this._viewToModelProportion).add(this._tablePos);e=e.scale(this._viewToModelProportion).add(this._tablePos),s*=this._viewToModelProportion,this._ctxCue.lineCap="round";for(let t=o.AIM_COLOR.length-1;t>=0;t--)this._ctxCue.filter="blur(".concat(2*(t+1),"px) opacity(0.4)"),this._ctxCue.strokeStyle=o.AIM_COLOR[t],this._ctxCue.lineWidth=t+1,this._ctxCue.beginPath(),this._ctxCue.moveTo(r.x,r.y),this._ctxCue.lineTo(e.x,e.y),this._ctxCue.stroke();this._ctxCue.filter="none"}fadeOutStart(){this._fadeStop=!1}fadeOutStop(){this._fadeStop=!0,this._fadeGenerator=this.fadeOutCue()}*fadeOutCue(){let t=1;for(;;){if(t-=.01,this._ctxCue.globalCompositeOperation="destination-in",this._ctxCue.fillStyle="rgba(255, 255, 255, ".concat(t,")"),this._ctxCue.fillRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight),!(t>0)||this._fadeStop)return void this._ctxCue.clearRect(0,0,this._cueSpaceWidth,this._cueSpaceHeight);yield}}animatePocketHitStart(t,e,i){this._animatePocketHitStop=!1,this._animatePocketHitGenerator=this.animatePocketHit(t,e,i)}animatePocketHitStop(){this._animatePocketHitStop=!0}*animatePocketHit(t,e,i){i*=this._viewToModelProportion,t=t.scale(this._viewToModelProportion);let s=e.pos.scale(this._viewToModelProportion);const r=t.substract(s).getNormalized(),h=2*i;let n=0,a=.5*e.vel;a>20&&(a=20),a<.5&&(a=.5);const l=i*o.SHADOW_SHIFT;for(;;){if(s===t)n+=.05,this._ctxBalls.globalCompositeOperation="destination-out",this._ctxBalls.fillStyle="rgba(255, 255, 255, ".concat(n,")"),this._ctxBalls.fillRect(s.x-i,s.y-i,h,h+l);else{this._ctxBalls.clearRect(s.x-i-1,s.y-i-1,h+2,h+l+2);const n=t.substract(s).getNormalized();s=s.add(r,a),(Math.abs(n.x-r.x)>1||Math.abs(n.y-r.y)>1)&&(s=t),this._ctxBalls.globalCompositeOperation="source-over",this._ctxBalls.drawImage(this._sprites.shadow,s.x-i,s.y-h+l,h,h),this._ctxBalls.fillStyle=o.BALLS_COLORS[e.type],this._ctxBalls.beginPath(),this._ctxBalls.arc(s.x,s.y,i,0,2*Math.PI,!1),this._ctxBalls.fill(),this._ctxBalls.drawImage(this._sprites.ball,s.x-i,s.y-i,h,h)}if(!(n<1))return void this._ctxBalls.clearRect(s.x-i-1,s.y-i-1,h+2,h+l+2);yield}}animate(){this._fadeStop||this._fadeGenerator.next().done&&this.fadeOutStop(),this._animatePocketHitStop||this._animatePocketHitGenerator.next().done&&this.animatePocketHitStop()}get viewToModelProportion(){return this._viewToModelProportion}}function r(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}s(o,"CUE_COLOR","#2f1212"),s(o,"DECOR_COLOR","#CFB725"),s(o,"TABLE_COLOR","#145127"),s(o,"BALLS_COLORS",{main:"#670730",ordinary:"#D9D9C3"}),s(o,"POCKET_COLORS",["#181111","#222222","#CFB725"]),s(o,"AIM_COLOR",["#FFFFFF","#FFF5D6","#FFC200"]),s(o,"WALL_COLORS",["#A47461","#C48B68","#733D29","#5E2D19","#60311D","#60311D","#60311D","#60311D","#5E2D1B","#411B10","#238E3B","#1D8C39","#238E3B","#177834"]),s(o,"SHADOW_SHIFT",1.3);class h{constructor(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ordinary";r(this,"_pos",void 0),r(this,"_dir",void 0),r(this,"_vel",void 0),r(this,"_type",void 0),this._pos=t,this._dir=new e(0,0),this._vel=0,this._removed=!1,this._type=i}simulate(){this.move(),this.slowDown()}slowDown(){this._vel-=h.FRICTION_KOEF,this._vel<0&&(this._vel=0)}move(){this._pos=this._pos.add(this._dir,this._vel)}collide(t){let e=this.pos.substract(t.pos);const i=e.getLength();if(0===i||i>=2*h.radius)return;e=e.getNormalized();const s=(2*h.radius-i)/2;this.pos=this.pos.add(e,s),t.pos=t.pos.add(e,-s);const o=this.dir.scale(this.vel),r=t.dir.scale(t.vel),n=o.dot(e),a=r.dot(e),l=(n+a-(n-a)*h.RESTITUTION)/2,_=(n+a-(a-n)*h.RESTITUTION)/2,c=o.add(e,l-n),d=r.add(e,_-a);this.dir=c.getNormalized(),t.dir=d.getNormalized(),this.vel=c.getLength(),t.vel=d.getLength()}isInPocket(t,e){return this._pos.substract(t).getLength()<=e}get pos(){return this._pos}set pos(t){this._pos=t}get dir(){return this._dir}set dir(t){t.isNormal()?this._dir=t:this._dir=t.getNormalized()}get vel(){return this._vel}set vel(t){t<0&&(t*=-1,this.dir=this.dir.scale(-1)),this._vel=t}get type(){return this._type}set type(t){this._type=t}}function n(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}r(h,"RESTITUTION",.8),r(h,"FRICTION_KOEF",.03),r(h,"radius",void 0),r(h,"adjusted_friction_koef",void 0);class a{constructor(t,e,i,s){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;n(this,"_x",void 0),n(this,"_y",void 0),n(this,"_width",void 0),n(this,"_height",void 0),n(this,"_rotate",void 0),this._x=t,this._y=e,this._width=i,this._height=s,this._rotate=o}findNearestVertexPos(t,i){const s=new e(i.x,i.y),o=new e(i.x+this._width,this.y+this._height);return Math.abs(s.x-t.x)<Math.abs(o.x-t.x)?Math.abs(s.y-t.y)<Math.abs(o.y-t.y)?{pos:s,horVector:new e(-1,0),vertVector:new e(0,-1)}:{pos:new e(i.x,i.y+this._height),horVector:new e(-1,0),vertVector:new e(0,1)}:Math.abs(s.y-t.y)<Math.abs(o.y-t.y)?{pos:new e(i.x+this._width,i.y),horVector:new e(1,0),vertVector:new e(0,-1)}:{pos:o,horVector:new e(1,0),vertVector:new e(0,1)}}collide(t,i){let s,o,r,h=!1;this._rotate?(h=!0,s=t.pos.getVectorInRotatedBasis(this._rotate),o=t.dir.getVectorInRotatedBasis(this._rotate),r=new e(this._x,this._y).getVectorInRotatedBasis(this._rotate)):(s=t.pos,o=t.dir,r=new e(this._x,this._y));const n=s.add(o,t.vel);if(this.isNextPosInBox(i,n,r)){if(n.y>r.y&&n.y<r.y+this._height)o.x*=-1,t.vel*=a.RESTITUTION,this.checkTrappedBall(s,o,t.vel,i,r);else if(n.x>r.x&&n.x<r.x+this._width)o.y*=-1,t.vel*=a.RESTITUTION,this.checkTrappedBall(s,o,t.vel,i,r);else{const e=this.findNearestVertexPos(n,r),h=n.substract(e.pos),l=h.getLength();if(l>i)return;let _=h.getNormalized();Math.abs(e.horVector.x-_.x)>1?_=e.vertVector:Math.abs(e.vertVector.y-_.y)>1&&(_=e.horVector);const c=2*o.dot(_);o=o.substract(_.scale(c)),s=s.add(_,i-l),t.vel*=a.RESTITUTION}this._rotate?(t.pos=s.getVectorInRotatedBasis(-this._rotate),t.dir=o.getVectorInRotatedBasis(-this._rotate)):(t.pos=s,t.dir=o)}}checkTrappedBall(t,e,i,s,o){const r=t.add(e,i);this.isNextPosInBox(s,r,o)&&(e.x*=-1,e.y*=-1)}isNextPosInBox(t,e,i){return e.x+t>i.x&&e.x-t<i.x+this._width&&e.y+t>i.y&&e.y-t<i.y+this._height}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get rotate(){return this._rotate}set rotate(t){this._rotate=t}}function l(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}n(a,"RESTITUTION",.7);class _{constructor(t){l(this,"_view",void 0),l(this,"_balls",void 0),l(this,"_walls",void 0),l(this,"_pockets",void 0),l(this,"_hitPower",void 0),l(this,"_targetPos",void 0),l(this,"_chosenBall",void 0),l(this,"_isFirstHit",void 0),l(this,"_isWaitingForHit",void 0),this._view=t,h.radius=_.BALL_RADIUS,this._oldTime=0,this._fpsAdhustKoef=1,this._isWaitingForHit=!0,this._isFirstHit=!0,this._hitPower=0,this._targetPos=new e(0,0),this.initPockets(),this.initWalls(),this.initBalls(),this.renderGame()}renderGame(){this._view.renderTable(_.POCKET_RADIUS),this._view.renderWalls(this._walls,_.POCKET_RADIUS,_.WALL_WIDTH),this._view.renderPockets(this._pockets,_.POCKET_RADIUS,_.WALL_WIDTH,_.POCKET_SHIFT_KOEF),this._view.renderBalls(this._balls,h.radius)}testingStart(){this._isWaitingForHit=!1,this._chosenBall.dir=new e(-.6865867239941715,.6370479148137013),this._chosenBall.vel=10}initBalls(){this._balls=new Array(16);let t=2*h.radius,i=Math.sqrt(3*h.radius*h.radius),s=_.TABLE_WIDTH/3*2,o=_.TABLE_HEIGHT/2,r=0,n=0,a=0,l=1,c=2;this._balls[0]=new h(new e(_.TABLE_WIDTH/4,o),"main"),this.chosenBall=this._balls[0];for(let _=1;_<16;_++)this._balls[_]=new h(new e(s+r,o+n+a)),a+=t+1,_%l==0&&(l+=c,r+=i+1,n-=h.radius,a=0,c++)}initWalls(){const t=2*_.POCKET_RADIUS,e=_.TABLE_WIDTH,i=_.TABLE_HEIGHT,s=_.WALL_WIDTH,o=2*s,r=Math.sqrt(t*t/2)+s,h=(e-t-2*r)/2,n=i-2*r,l=r+h+t;this._walls=[],this._walls[0]=new a(r,0,h,s),this._walls[1]=new a(l,0,h,s),this._walls[2]=new a(r,i-s,h,s),this._walls[3]=new a(l,i-s,h,s),this._walls[4]=new a(0,r,s,n),this._walls[5]=new a(e-s,r,s,n),this._walls[6]=new a(s,r,o,o,3*Math.PI/4),this._walls[7]=new a(r,s,o,o,3*-Math.PI/4),this._walls[8]=new a(e-s,r,o,o,-Math.PI/4),this._walls[9]=new a(e-r,s,o,o,3*-Math.PI/4),this._walls[10]=new a(e-s,i-r,o,o,-Math.PI/4),this._walls[11]=new a(e-r,i-s,o,o,Math.PI/4),this._walls[12]=new a(s,i-r,o,o,3*Math.PI/4),this._walls[13]=new a(r,i-s,o,o,Math.PI/4)}initPockets(){const t=_.POCKET_RADIUS*(1+_.POCKET_SHIFT_KOEF),i=_.TABLE_WIDTH,s=_.TABLE_HEIGHT;this._pockets=[],this._pockets[0]=new e(t,t),this._pockets[1]=new e(i-t,t),this._pockets[2]=new e(i-t,s-t),this._pockets[3]=new e(t,s-t),this._pockets[4]=new e(i/2,t),this._pockets[5]=new e(i/2,s-t)}async start(){let t=performance.now();const e=1e3/_.INTENDED_FPS;let i=0;for(;;){let s=await new Promise(requestAnimationFrame);s-t<e-i||(i=Math.min(e,i+s-t-e),t=s,this.run())}}run(){if(this._isWaitingForHit){this._view.fadeOutStop(),this._view.renderCue(this._chosenBall.pos,this._targetPos,h.radius,this._hitPower);const t=this.updateTargetPoint();this._view.showAimLine(this._chosenBall,t.pos,t.fromBallDir,h.radius)}else this.update(),this._view.renderBalls(this._balls,h.radius);this._view.animate()}update(){let t,e=!0;t:for(let i=0;i<this._balls.length;i++){t=this._balls[i];for(let e=i+1;e<this._balls.length;e++)t.collide(this._balls[e]);for(let e of this._walls)e.collide(t,h.radius);t.simulate();for(let e of this._pockets)if(this.checkPocket(e,t)){if(this._view.animatePocketHitStart(e,t,h.radius),this._balls.splice(i,1),!this._balls)return void this.endGame();this._chosenBall===t&&(this._chosenBall=this._balls[0]),i--;continue t}0!==t.vel&&(e=!1)}e&&(this._isWaitingForHit=!0,this._balls.length<2)&&this.endGame()}chooseBall(t){if(!this._isFirstHit)for(let e=0;e<this._balls.length;e++){if(this._balls[e].pos.substract(t).getLength()<=h.radius)return void(this._chosenBall=this._balls[e])}}hitBall(){!this._balls.includes(this._chosenBall)||this._hitPower<.05||(this._isWaitingForHit=!1,this._isFirstHit=!1,this._chosenBall.dir=this._targetPos.substract(this._chosenBall.pos),this._chosenBall.vel=this._hitPower*_.MAX_HIT_POWER,this._view.renderCue(this.chosenBall.pos,this.targetPos,h.radius),this._view.fadeOutStart())}updateTargetPoint(){if(!this._chosenBall)return;let t={};const e=this._targetPos.substract(this._chosenBall.pos).getNormalized();t.fromBallDir=e;let i=Number.POSITIVE_INFINITY;for(let t of this._balls)t!==this._chosenBall&&(i=this.findIntersectionDistOfLineAndCircle(e,this._chosenBall.pos,t.pos,i,h.radius));return Number.isFinite(i)?t.pos=this._chosenBall.pos.add(e,i):t.pos=this.findIntersectionWithWall(e.x,e.y,this._chosenBall.pos.x,this._chosenBall.pos.y),t}findIntersectionWithWall(t,i,s,o){const r=new e(0,0);let h,n,a=1,l=1;t>0?(h=_.TABLE_WIDTH-_.WALL_WIDTH-s,r.x=_.TABLE_WIDTH-_.WALL_WIDTH):(h=s-_.WALL_WIDTH,r.x=_.WALL_WIDTH,a=-1),i<0?(n=o-_.WALL_WIDTH,r.y=_.WALL_WIDTH,l=-1):(n=_.TABLE_HEIGHT-_.WALL_WIDTH-o,r.y=_.TABLE_HEIGHT-_.WALL_WIDTH);let c=!1;c=0!==t&&(0===i||h/Math.abs(t)<n/Math.abs(i));const d=Math.acos(Math.abs(t));return c?(n=h*Math.tan(d),r.y=o+n*l):(h=n/Math.tan(d),r.x=s+h*a),r}findIntersectionDistOfLineAndCircle(t,e,i,s,o){const r=e.substract(i),h=2*r.dot(t),n=h*h-4*(r.dot(r)-o*o);if(n<0)return s;let a=(-h-Math.sqrt(n))/2,l=(-h+Math.sqrt(n))/2,_=Math.min(a,l);return _<0||_>s?s:_}checkPocket(t,e){return e.pos.substract(t).getLength()<_.POCKET_RADIUS}endGame(){this.restart()}restart(){this.initBalls(),this._isWaitingForHit=!0,this._isFirstHit=!0,this._hitPower=0,this._view.renderBalls(this._balls,h.radius)}set targetPos(t){this._targetPos=t}get targetPos(){return this._targetPos}set chosenBall(t){this._chosenBall=t}get chosenBall(){return this._chosenBall}set hitPower(t){t<0?t=0:t>1&&(t=1),this._hitPower=t}get hitPower(){return this._hitPower}set isWaitingForHit(t){this._isWaitingForHit=t}get isWaitingForHit(){return this._isWaitingForHit}get canvasAdjKoef(){return this._canvasAdjKoef}}function c(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}l(_,"WALL_WIDTH",80),l(_,"BALL_RADIUS",20),l(_,"TABLE_WIDTH",2048),l(_,"TABLE_HEIGHT",1024),l(_,"INTENDED_FPS",60),l(_,"MAX_HIT_POWER",30),l(_,"POCKET_RADIUS",35),l(_,"WALL_RESTITUTION",.65),l(_,"POCKET_SHIFT_KOEF",.5);class d{constructor(t,e,i){c(this,"_model",void 0),c(this,"_canvasRect",void 0),c(this,"_mouseMoveFunction",void 0),c(this,"_mouseDownFunction",void 0),c(this,"_modelToControlProportion",void 0),this._model=t,this._canvasRect=e.getBoundingClientRect(),this._modelToControlProportion=1/i,this.initMouseControl()}resizeInit(t,e){this._canvasRect=t.getBoundingClientRect(),this._modelToControlProportion=1/e}initMouseControl(){let t,i=null,s=new e(0,0);window.addEventListener("mousemove",(o=>{const r=new e(o.clientX-this._canvasRect.x,o.clientY-this._canvasRect.y);i?(s=r.substract(i),this._model.hitPower=4*this._modelToControlProportion*t.dot(s)/this._canvasRect.width):(s=new e(0,0),this._model.targetPos=r.scale(this._modelToControlProportion))})),window.addEventListener("mousedown",(s=>{this._model.isWaitingForHit&&(i=new e(s.clientX-this._canvasRect.x,s.clientY-this._canvasRect.y),t=this._model.chosenBall.pos.scale(1/this._modelToControlProportion).substract(i).getNormalized(),window.addEventListener("mouseup",(()=>{this._model.hitPower<d.HIT_POWER_TRASHOLD?this._model.chooseBall(i.scale(this._modelToControlProportion)):this._model.hitBall(),this._model.hitPower=0,i=null}),{once:!0}))})),document.getElementById("restart").addEventListener("click",(()=>{this._model.restart()}))}mouseMoveFunction(){}mouseDownFunction(){}}c(d,"HIT_POWER_TRASHOLD",.05);const u=document.getElementById("canvas-table"),p=document.getElementById("canvas-balls"),v=document.getElementById("canvas-cue");let x,g,w;const f=function(){const t=u.getBoundingClientRect(),e=t.width,i=t.height;u.width=e,u.height=i,p.width=e,p.height=i,v.width=window.innerWidth,v.height=window.innerHeight},y=async function(){f(),await x.init(u,v,_.TABLE_WIDTH),g.renderGame(),w.resizeInit(u,x.viewToModelProportion)};window.addEventListener("load",(async function(){f(),x=new o(u,p,v),await x.init(u,v,_.TABLE_WIDTH),g=new _(x),w=new d(g,u,x.viewToModelProportion),g.start(),window.addEventListener("resize",y)})),console.log("v2")})()})();